---
title: "GI Transit Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    theme: cosmo
    runtime: shiny
---

<style>
/* Make sidebar wider */
.sidebar {
  width: 200px !important;   /* Increase width */
  position: fixed !important;
  left: 0;
  top: 60px;
  bottom: 0;
  overflow-y: auto;
  z-index: 9999;
  background-color: #f8f9fa;
  padding-right: 1000px;  /* Adjust padding */
  border-right: 1px solid #ddd;
}

/* Shift main content to the right */
.main {
  margin-left: 600px !important;   /* Ensure the main content is shifted properly */
  padding: 10px;  /* Adjust padding for better layout */
}
</style>

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(plotly)
library(ggplot2)
library(crosstalk)
library(readr)
library(readxl)
library(magrittr)
library(tidyverse)
library(dplyr)

# Example dataset (replace with your actual data)
gidxa <- read_excel("clean_data/71824Parquette.xlsx")

# Data processing
gidxa$get_min <- as.numeric(gidxa$get_min)
gidxa$ctt_min_tot <- as.numeric(gidxa$ctt_min_tot)
gidxa$get_categories <- cut(gidxa$get_min, breaks = c(-Inf, 60, 240, Inf),
                            labels = c(">1 hour", "1-4 hours", "<4 hours"))
gidxa$ctt_categories <- cut(gidxa$ctt_min_tot, breaks = c(-Inf, 720, 3560, Inf),
                            labels = c(">12 hours", "12-59 hours", "<59 hours"))
gidxa$wgtt_categories <- cut(gidxa$wgtt_tot_min, breaks = c(-Inf, 600, 4320, Inf),
                             labels = c("Rapid", "Normal", "Delayed"))
gidxa$gender <- factor(gidxa$gender, 
                       levels = c("F", "M"),
                       labels = c("Female", "Male"))
# Factor BMI
gidxa$bmi_categories <- cut(gidxa$bmi, breaks = c(-Inf, 30, 35, Inf),
                            labels = c("Overweight", "Class 1 Obesity", "Class 2 Obesity"))

# Shared data for filtering
shared_df <- SharedData$new(gidxa, group = "GI_data")
```

Description
=======================================================================

### GI Transit and Body Composition Study

This dashboard explores how **gastrointestinal (GI) transit times** relate to **body composition** and **gender/BMI differences**.

The data set is confidential data as collected by a clinical feeding trial. These data was collected between 2021 and 2024 at the Georgia Clinical and Translational Science Association in collaboration with Emory University in adults aged 40-75 with a history of colon polyps within the past 3 years. 

 Gastric Emptying Time
=====================================

Row {.tabset}
------------------------------------------------------------------------

### Sidebar {.sidebar}

```{r}
filter_slider("get_min", "Gastric Emptying Time (min)", shared_df, ~get_min)
filter_select("gender", "Gender", shared_df, ~gender)
filter_select("bmi_categories", "BMI Category", shared_df, ~bmi_categories)

filtered_data <- reactive({
  shared_df$filtered()
})
```

Row
------------------------------------------------------------------------
### Gender & Gastric Emptying{.column width=6}
```{r}
renderPlotly({
  df <- filtered_data()
  plot_ly(df, x = ~gender, y = ~get_min, type = 'box', color = ~gender,
          colors = c("#E377C2", "#1F77B4")) %>%
    layout(title = "Gastric Emptying Time by Gender",
           xaxis = list(title = "Gender"),
           yaxis = list(title = "Time (minutes)"))
})
renderUI({
  div(style="padding:1em", 
      h4("Takeaway"),
      p("Gastric Emptying Time varies more among men than among women, however, average gastric emptying time remains similar reagrdless of gender. "))
})
```

### Gastric Emptying & BMI Category {.column width=6}
```{r}
renderPlotly({
  df <- filtered_data()
  plot_ly(df, x = ~bmi_categories, y = ~get_min, type = 'box', color = ~bmi_categories,
          colors = c("#FF7F0E", "#2CA02C", "#9467BD")) %>%
    layout(title = "Gastric Emptying Time by BMI Category",
           xaxis = list(title = "BMI Category"),
           yaxis = list(title = "Time (minutes)"))
})

renderUI({
  div(style="padding:1em", 
      h4("Takeaway"),
      p("Gastric Emptying Time varies more among men than among women, however, average gastric emptying time remains similar reagrdless of gender. "))
})
```

Row
------------------------------------------------------------------------
### Gastric Emptying & Body Fat % {.column width=12}
```{r}
renderPlotly({
  df <- filtered_data()

  p <- ggplot(df, aes(x = get_min, y = dxa_fat_p, color = gender)) +
    geom_point(alpha = 0.7, size = 3) +
    facet_wrap(~bmi_categories) +
    labs(title = "GI Transit Time vs Body Fat Percentage",
         x = "GI Transit Time (Minutes)",
         y = "Body Fat Percentage (%)",
         color = "Gender") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "top")

  ggplotly(p, tooltip = c("x", "y", "color")) %>%
    config(displayModeBar = FALSE) %>%
    layout(autosize = TRUE, margin = list(l = 50, r = 50, b = 80, t = 50))
})

renderUI({
  div(style="padding:1em", 
      h4("Takeaway"),
      p("Body composition, particularly body fat percentage, seems to have a greater impact on gastric emptying time than BMI obesity classifications alone."))
})
```

Colonic Transit Time
=====================================
Row
------------------------------------------------------------------------

### Sidebar {.sidebar}
```{r}
filter_slider("ctt_min_tot", "Colonic Transit Time (min)", shared_df, ~get_min)
filter_select("gender", "Gender", shared_df, ~gender)
filter_select("bmi_categories", "BMI Category", shared_df, ~bmi_categories)

filtered_data <- reactive({
  shared_df$data(withSelection = TRUE)
})

```

Column {width=6}
------------------------------------------------------------------------
### Gender & Colonic Transit Time
```{r}
renderPlotly({
  df <- filtered_data()
  plot_ly(df, x = ~gender, y = ~ctt_min_tot, type = 'box', color = ~gender,
          colors = c("#E377C2", "#1F77B4")) %>%
    layout(title = "Colonic Transit Time by Gender",
           xaxis = list(title = "Gender"),
           yaxis = list(title = "Time (minutes)"))
})

```

### Colonic Transit Time & Body Fat %

```{r}
renderPlotly({
  df <- filtered_data()

  p <- ggplot(df, aes(x = ctt_min_tot, y = dxa_fat_p, color = gender)) +
    geom_point(alpha = 0.7, size = 3) +
    facet_wrap(~bmi_categories) +
    labs(title = "Colonic Transit & Body Fat Percentage",
         x = "Colonic Transit Time (Minutes)",
         y = "Body Fat Percentage (%)",
         color = "Gender") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "top")

  ggplotly(p, tooltip = c("x", "y", "color")) %>%
    config(displayModeBar = FALSE) %>%
    layout(autosize = TRUE, margin = list(l = 50, r = 50, b = 80, t = 50))
})
 
```

Column
------------------------------------------------------------------------

### By BMI Category
```{r}
renderPlotly({
  df <- filtered_data()
  plot_ly(df, x = ~bmi_categories, y = ~ctt_min_tot, type = 'box', color = ~bmi_categories,
          colors = c("#FF7F0E", "#2CA02C", "#9467BD")) %>%
    layout(title = "Colonic Transit Time by BMI Category",
           xaxis = list(title = "BMI Category"),
           yaxis = list(title = "Time (minutes)"))
})
```

### Key Takeaways
```{r}
renderUI({
  div(style="padding:1em", 
      h4("Key Takeaways"),
      p("Colonic Transit time shows differences by gender and BMI class. Higher fat percentage may relate to longer emptying times in certain categories."))
})
```


Whole Gut Transit Time
=====================================
Row
------------------------------------------------------------------------

### Sidebar {.sidebar}
```{r}
filter_slider("wgtt_tot_min", "Whole Gut Transit Time (min)", shared_df, ~get_min)
filter_select("gender", "Gender", shared_df, ~gender)
filter_select("bmi_categories", "BMI Category", shared_df, ~bmi_categories)

filtered_data <- reactive({
  shared_df$data(withSelection = TRUE)
})

```

Column
------------------------------------------------------------------------
### Gender & Whole Gut Transit Time
```{r}
renderPlotly({
  df <- filtered_data()
  plot_ly(df, x = ~gender, y = ~wgtt_tot_min, type = 'box', color = ~gender,
          colors = c("#E377C2", "#1F77B4")) %>%
    layout(title = "Whole Gut Transit Time by Gender",
           xaxis = list(title = "Gender"),
           yaxis = list(title = "Time (minutes)"))
})

```

### Whole Gut Transit Time & Body Fat %

```{r}
renderPlotly({
  df <- filtered_data()

  p <- ggplot(df, aes(x = wgtt_tot_min, y = dxa_fat_p, color = gender)) +
    geom_point(alpha = 0.7, size = 3) +
    facet_wrap(~bmi_categories) +
    labs(title = "Whole Gut Transit & Body Fat Percentage",
         x = "Whole Gut Transit Time (Minutes)",
         y = "Body Fat Percentage (%)",
         color = "Gender") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "top")

  ggplotly(p, tooltip = c("x", "y", "color")) %>%
    config(displayModeBar = FALSE) %>%
    layout(autosize = TRUE, margin = list(l = 50, r = 50, b = 80, t = 50))
})
 
```

Column
------------------------------------------------------------------------

### By BMI Category
```{r}
renderPlotly({
  df <- filtered_data()
  plot_ly(df, x = ~bmi_categories, y = ~wgtt_tot_min, type = 'box', color = ~bmi_categories,
          colors = c("#FF7F0E", "#2CA02C", "#9467BD")) %>%
    layout(title = "Whole Gut Transit Time by BMI Category",
           xaxis = list(title = "BMI Category"),
           yaxis = list(title = "Time (minutes)"))
})
```

### Key Takeaways
```{r}
renderUI({
  div(style="padding:1em", 
      h4("Key Takeaways"),
      p("Whole Gut Transit time shows differences by gender and BMI class. Higher fat percentage may relate to longer emptying times in certain categories."))
})
```


