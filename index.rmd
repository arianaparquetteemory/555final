---
title: "GI Transit Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    theme: cosmo
---

<style>
.sidebar {
  width: 200px !important;
  position: fixed !important;
  left: 0;
  top: 60px;
  bottom: 0;
  overflow-y: auto;
  z-index: 9999;
  background-color: #f8f9fa;
  padding-right: 10px;
  border-right: 1px solid #ddd;
}
.main {
  margin-left: 250px !important;
  padding: 10px;
}
</style>

```{r setup, include=FALSE}
library(flexdashboard)
library(plotly)
library(ggplot2)
library(crosstalk)
library(readr)
library(readxl)
library(tidyverse)

# Load data
gidxa <- read_excel("clean_data/71824Parquette.xlsx")

# Preprocessing
gidxa <- gidxa %>%
  mutate(
    get_min = as.numeric(get_min),
    ctt_min_tot = as.numeric(ctt_min_tot),
    wgtt_tot_min = as.numeric(wgtt_tot_min),
    get_categories = cut(get_min, breaks = c(-Inf, 60, 240, Inf),
                         labels = c(">1 hour", "1-4 hours", "<4 hours")),
    ctt_categories = cut(ctt_min_tot, breaks = c(-Inf, 720, 3560, Inf),
                         labels = c(">12 hours", "12-59 hours", "<59 hours")),
    wgtt_categories = cut(wgtt_tot_min, breaks = c(-Inf, 600, 4320, Inf),
                          labels = c("Rapid", "Normal", "Delayed")),
    gender = factor(gender, levels = c("F", "M"), labels = c("Female", "Male")),
    bmi_categories = cut(bmi, breaks = c(-Inf, 30, 35, Inf),
                         labels = c("Overweight", "Class 1 Obesity", "Class 2 Obesity"))
  )

shared_df <- SharedData$new(gidxa)
```

Description
=======================================================================

### GI Transit and Body Composition Study

This dashboard explores how **gastrointestinal (GI) transit times** relate to **body composition** and **gender/BMI differences**.

Gastric Emptying Time
=====================================

Row {.tabset}
------------------------------------------------------------------------

### Sidebar {.sidebar}
```{r}
filter_slider("get_min", "Gastric Emptying Time (min)", shared_df, ~get_min)
filter_select("gender", "Gender", shared_df, ~gender)
filter_select("bmi_categories", "BMI Category", shared_df, ~bmi_categories)
```

Row
------------------------------------------------------------------------

### Gender & Gastric Emptying {.column width=6}
```{r}
plot_ly(shared_df, x = ~gender, y = ~get_min, type = 'box', color = ~gender,
        colors = c("#E377C2", "#1F77B4")) %>%
  layout(title = "Gastric Emptying Time by Gender",
         xaxis = list(title = "Gender"),
         yaxis = list(title = "Time (minutes)"))
```

### Gastric Emptying & BMI Category {.column width=6}
```{r}
plot_ly(shared_df, x = ~bmi_categories, y = ~get_min, type = 'box', color = ~bmi_categories,
        colors = c("#FF7F0E", "#2CA02C", "#9467BD")) %>%
  layout(title = "Gastric Emptying Time by BMI Category",
         xaxis = list(title = "BMI Category"),
         yaxis = list(title = "Time (minutes)"))
```

Row
------------------------------------------------------------------------

### Gastric Emptying & Body Fat % {.column width=12}
```{r}
p <- ggplot(shared_df, aes(x = get_min, y = dxa_fat_p, color = gender)) +
  geom_point(alpha = 0.7, size = 3) +
  facet_wrap(~bmi_categories) +
  labs(title = "GI Transit Time vs Body Fat Percentage",
       x = "GI Transit Time (Minutes)",
       y = "Body Fat Percentage (%)",
       color = "Gender") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "top")

ggplotly(p, tooltip = c("x", "y", "color")) %>%
  config(displayModeBar = FALSE)
```

Colonic Transit Time
=====================================

Row
------------------------------------------------------------------------

### Sidebar {.sidebar}
```{r}
filter_slider("ctt_min_tot", "Colonic Transit Time (min)", shared_df, ~ctt_min_tot)
filter_select("gender", "Gender", shared_df, ~gender)
filter_select("bmi_categories", "BMI Category", shared_df, ~bmi_categories)
```

Column {width=6}
------------------------------------------------------------------------

### Gender & Colonic Transit Time
```{r}
plot_ly(shared_df, x = ~gender, y = ~ctt_min_tot, type = 'box', color = ~gender,
        colors = c("#E377C2", "#1F77B4")) %>%
  layout(title = "Colonic Transit Time by Gender",
         xaxis = list(title = "Gender"),
         yaxis = list(title = "Time (minutes)"))
```

### Colonic Transit Time & Body Fat %
```{r}
p <- ggplot(shared_df, aes(x = ctt_min_tot, y = dxa_fat_p, color = gender)) +
  geom_point(alpha = 0.7, size = 3) +
  facet_wrap(~bmi_categories) +
  labs(title = "Colonic Transit & Body Fat Percentage",
       x = "Colonic Transit Time (Minutes)",
       y = "Body Fat Percentage (%)",
       color = "Gender") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "top")

ggplotly(p, tooltip = c("x", "y", "color")) %>%
  config(displayModeBar = FALSE)
```

Column
------------------------------------------------------------------------

### Colonic Transit & BMI
```{r}
plot_ly(shared_df, x = ~bmi_categories, y = ~ctt_min_tot, type = 'box', color = ~bmi_categories,
        colors = c("#FF7F0E", "#2CA02C", "#9467BD")) %>%
  layout(title = "Colonic Transit Time by BMI Category",
         xaxis = list(title = "BMI Category"),
         yaxis = list(title = "Time (minutes)"))
```

Whole Gut Transit Time
=====================================

Row
------------------------------------------------------------------------

### Sidebar {.sidebar}
```{r}
filter_slider("wgtt_tot_min", "Whole Gut Transit Time (min)", shared_df, ~wgtt_tot_min)
filter_select("gender", "Gender", shared_df, ~gender)
filter_select("bmi_categories", "BMI Category", shared_df, ~bmi_categories)
```

Column
------------------------------------------------------------------------

### Gender & Whole Gut Transit Time
```{r}
plot_ly(shared_df, x = ~gender, y = ~wgtt_tot_min, type = 'box', color = ~gender,
        colors = c("#E377C2", "#1F77B4")) %>%
  layout(title = "Whole Gut Transit Time by Gender",
         xaxis = list(title = "Gender"),
         yaxis = list(title = "Time (minutes)"))
```

### Whole Gut Transit Time & Body Fat %
```{r}
p <- ggplot(shared_df, aes(x = wgtt_tot_min, y = dxa_fat_p, color = gender)) +
  geom_point(alpha = 0.7, size = 3) +
  facet_wrap(~bmi_categories) +
  labs(title = "Whole Gut Transit & Body Fat Percentage",
       x = "Whole Gut Transit Time (Minutes)",
       y = "Body Fat Percentage (%)",
       color = "Gender") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "top")

ggplotly(p, tooltip = c("x", "y", "color")) %>%
  config(displayModeBar = FALSE)
```

Column
------------------------------------------------------------------------

### WGTT & BMI
```{r}
plot_ly(shared_df, x = ~bmi_categories, y = ~wgtt_tot_min, type = 'box', color = ~bmi_categories,
        colors = c("#FF7F0E", "#2CA02C", "#9467BD")) %>%
  layout(title = "Whole Gut Transit Time by BMI Category",
         xaxis = list(title = "BMI Category"),
         yaxis = list(title = "Time (minutes)"))
